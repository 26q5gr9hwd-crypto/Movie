import{_ as O,r as u,c as q,o as V,a as G,b as c,d as r,e as s,f as S,w as Q,g as m,t as F,T as X,h as Z,u as ee,i as ae,j as te,k as se,l as le,n as I,m as oe,v as ne,p as L,q as re,s as A,x as b,y as K,E as N,z as ie,A as ue,B as ce,C as ve,D as C,F as de,G as pe,H as fe,U as R,I as he,J as me}from"./index-BI43qcjr.js";import{B as ge}from"./BaseModal-DlrAL1Cf.js";import{D as ye,S as ke,M as U}from"./MovieList-BoMCff_2.js";const _e={class:"donaters-wrapper"},H="donatersCache",we={__name:"FooterDonaters",setup(P){const v=u([]),g=u(-1);let d=null;const n=q(()=>g.value===-1||!v.value.length?"":v.value[g.value]),a=async()=>{const p=new Date().toISOString().split("T")[0],h=localStorage.getItem(H);if(h)try{const{date:o,data:f}=JSON.parse(h);if(o===p){v.value=f;return}}catch(o){console.error("Ошибка кэша донатеров:",o)}try{const o=await Z();v.value=o.split("\n").map(f=>f.trim()).filter(f=>f),localStorage.setItem(H,JSON.stringify({date:p,data:v.value}))}catch(o){console.error("Ошибка загрузки донатеров:",o)}};function y(){if(!v.value.length)return;const p=Math.floor(Math.random()*v.value.length);g.value=p}function i(){v.value.length!==0&&(y(),d=setInterval(y,4e3))}return V(async()=>{await a(),i()}),G(()=>{d&&clearInterval(d)}),(p,h)=>(r(),c("footer",null,[s("div",_e,[S(X,{name:"fade",mode:"out-in"},{default:Q(()=>[n.value?(r(),c("span",{key:g.value,class:"donater"},F(n.value),1)):m("",!0)]),_:1})])]))}},Ie=O(we,[["__scopeId","data-v-5dec4e96"]]),Se={class:"wrapper"},De={class:"mainpage"},be={class:"search-type-buttons"},Ce={class:"search-container"},Me={class:"input-wrapper"},Te=["placeholder","inputmode","onKeydown"],Ee={class:"icons"},$e={class:"content-container"},xe={key:0},Be={key:0},Le={key:0,class:"loading-container"},Ae={key:1,class:"empty-history"},Ke={key:2},Ne={key:0,class:"no-results"},Re={key:3,class:"search-prompt"},Ue={__name:"MovieSearch",setup(P){const v=ee(),g=ae(),d=ie(),n=u("title"),a=u(""),y=u([]),i=u(!1),p=u(!1),h=u(!1),o=u(""),f=u(null),k=u([]),_=u(!1),M=u("");te(async()=>{if(g.token){i.value=!0;try{k.value=await fe(R.HISTORY)}catch(t){const{message:e,code:l}=C(t);o.value=e,f.value=l,console.error("Ошибка загрузки истории:",t),l===401&&(g.logout(),await d.push("/login"),d.go(0))}finally{i.value=!1}}else k.value=v.history});function W(t){k.value=k.value.filter(e=>e.kp_id!==t)}const w=t=>{n.value=t,T(),_.value=!1},Y=t=>{n.value==="title"?(a.value=t.target.value,_.value=de(a.value),_.value&&(M.value=pe(a.value))):a.value=t.target.value.replace(/\D+/g,"")},J=()=>{_.value&&(a.value=he(a.value),_.value=!1)},z=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[n.value]||"Введите название фильма",T=()=>{a.value="",y.value=[],p.value=!1},E=()=>{$.cancel(),a.value?D():alert("Введите запрос для поиска")},D=async()=>{i.value=!0,p.value=!0,y.value=[];try{if(n.value==="kinopoisk"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,"")),d.push({name:"movie-info",params:{kp_id:a.value}});return}if(n.value==="imdb"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await ue(a.value);if(t.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="shikimori"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await ce(a.value);if(t.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="title"){const t=await ve(a.value);y.value=t.map(e=>{var l,x,B;return{...e,kp_id:e.id.toString(),rating_kp:((l=e.raw_data)==null?void 0:l.rating)!=="null"?(x=e.raw_data)==null?void 0:x.rating:null,type:(B=e.raw_data)==null?void 0:B.type}})}}catch(t){const{message:e,code:l}=C(t);o.value=e,f.value=l,console.error("Ошибка при поиске:",t)}finally{i.value=!1}},j=async()=>{if(i.value=!0,g.token)try{await me(R.HISTORY),k.value=[],i.value=!1,h.value=!1}catch(t){const{message:e,code:l}=C(t);o.value=e,f.value=l,console.error("Ошибка загрузки истории:",t),l===401&&(g.logout(),await d.push("/login"),d.go(0)),i.value=!1,h.value=!1}else v.clearAllHistory(),i.value=!1,h.value=!1},$=se(()=>{a.value.length>=2?D():a.value.length<2&&(y.value=[],p.value=!1)},700);return V(()=>{const t=window.location.hash;if(t.startsWith("#search=")){const e=decodeURIComponent(t.replace("#search=",""));a.value=e,D()}else if(t.startsWith("#imdb=")){const e=decodeURIComponent(t.replace("#imdb=",""));w("imdb"),a.value=e,D()}else if(t.startsWith("#shiki")){const e=decodeURIComponent(t.replace("#shiki",""));w("shikimori"),a.value=e,D()}}),le(a,()=>{n.value==="title"&&$()}),(t,e)=>(r(),c("div",Se,[s("div",De,[s("div",be,[s("button",{class:I({active:n.value==="title"}),onClick:e[0]||(e[0]=l=>w("title"))}," Название ",2),s("button",{class:I({active:n.value==="kinopoisk"}),onClick:e[1]||(e[1]=l=>w("kinopoisk"))}," ID Кинопоиск ",2),s("button",{class:I({active:n.value==="shikimori"}),onClick:e[2]||(e[2]=l=>w("shikimori"))}," ID Shikimori ",2),s("button",{class:I({active:n.value==="imdb"}),onClick:e[3]||(e[3]=l=>w("imdb"))}," ID IMDB ",2)]),s("div",Ce,[s("div",Me,[oe(s("input",{ref:"searchInput","onUpdate:modelValue":e[4]||(e[4]=l=>a.value=l),placeholder:z(),class:I(["search-input",{"wrong-layout":_.value}]),inputmode:n.value==="title"?"text":"numeric",onKeydown:[L(E,["enter"]),L(re(J,["prevent"]),["tab"])],onInput:Y},null,42,Te),[[ne,a.value]]),s("div",Ee,[a.value?(r(),c("button",{key:0,class:"reset-button",onClick:T},e[7]||(e[7]=[s("i",{class:"fas fa-times"},null,-1)]))):m("",!0),s("button",{class:"search-button",onClick:E},e[8]||(e[8]=[s("i",{class:"fas fa-search"},null,-1)]))]),_.value?(r(),c("div",{key:0,class:I(["layout-warning",{show:_.value}])},[e[9]||(e[9]=s("i",{class:"fas fa-keyboard"},null,-1)),A(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+F(M.value)+" раскладку ",1)],2)):m("",!0)])]),s("div",$e,[a.value?m("",!0):(r(),c("div",xe,[s("h2",null,[e[10]||(e[10]=A(" История просмотра ")),k.value.length>0?(r(),c("span",Be,[S(ye,{onClick:e[5]||(e[5]=l=>h.value=!0)}),S(ge,{"is-open":h.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:j,onClose:e[6]||(e[6]=l=>h.value=!1)},null,8,["is-open"])])):m("",!0)]),i.value?(r(),c("div",Le,[S(ke)])):k.value.length===0?(r(),c("div",Ae,e[11]||(e[11]=[s("span",{class:"material-icons"},"movie",-1),s("p",null,"Здесь пока пусто",-1)]))):(r(),b(K(U),{key:2,"movies-list":k.value,"is-history":!0,loading:!1,onItemDeleted:W},null,8,["movies-list"]))])),!a.value&&o.value?(r(),b(N,{key:1,message:o.value,code:f.value},null,8,["message","code"])):m("",!0),p.value?(r(),c("div",Ke,[e[12]||(e[12]=s("h2",null,"Результаты поиска",-1)),S(K(U),{"movies-list":y.value,"is-history":!1,loading:i.value},null,8,["movies-list","loading"]),y.value.length===0&&!i.value&&!o.value?(r(),c("div",Ne," Ничего не найдено ")):m("",!0),o.value?(r(),b(N,{key:1,message:o.value,code:f.value},null,8,["message","code"])):m("",!0)])):m("",!0),a.value&&!p.value&&!i.value&&!o.value?(r(),c("div",Re,' Нажмите кнопку "Поиск" или Enter для поиска ')):m("",!0)])]),S(Ie)]))}},Fe=O(Ue,[["__scopeId","data-v-cdfd6c03"]]);export{Fe as default};
//# sourceMappingURL=MovieSearch-BkvzlM3R.js.map
