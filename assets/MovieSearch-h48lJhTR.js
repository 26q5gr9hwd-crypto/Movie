import{_ as V,r as u,c as X,o as P,a as Z,b as c,d as r,e as o,f as S,w as ee,g,t as W,T as ae,h as te,u as se,i as oe,j as le,k as ne,l as re,n as I,m as ie,v as ue,p as C,q as K,s as N,x as b,y as R,E as U,z as ce,A as ve,B as de,C as pe,D as M,F as fe,G as he,H as me,U as H,I as ge,J as ye}from"./index-CuZJqkBF.js";import{B as ke}from"./BaseModal-BiuLi2xO.js";import{D as _e,S as we,M as O}from"./MovieList-C5mTbefh.js";const Ie={class:"donaters-wrapper"},F="donatersCache",Se={__name:"FooterDonaters",setup(Y){const v=u([]),y=u(-1);let d=null;const n=X(()=>y.value===-1||!v.value.length?"":v.value[y.value]),a=async()=>{const p=new Date().toISOString().split("T")[0],m=localStorage.getItem(F);if(m)try{const{date:l,data:f}=JSON.parse(m);if(l===p){v.value=f;return}}catch(l){console.error("Ошибка кэша донатеров:",l)}try{const l=await te();v.value=l.split("\n").map(f=>f.trim()).filter(f=>f),localStorage.setItem(F,JSON.stringify({date:p,data:v.value}))}catch(l){console.error("Ошибка загрузки донатеров:",l)}};function h(){if(!v.value.length)return;const p=Math.floor(Math.random()*v.value.length);y.value=p}function i(){v.value.length!==0&&(h(),d=setInterval(h,4e3))}return P(async()=>{await a(),i()}),Z(()=>{d&&clearInterval(d)}),(p,m)=>(r(),c("footer",null,[o("div",Ie,[S(ae,{name:"fade",mode:"out-in"},{default:ee(()=>[n.value?(r(),c("span",{key:y.value,class:"donater"},W(n.value),1)):g("",!0)]),_:1})])]))}},De=V(Se,[["__scopeId","data-v-5dec4e96"]]),Ce={class:"wrapper"},be={class:"mainpage"},Me={class:"search-type-buttons"},Te={class:"search-container"},Ee={class:"input-wrapper"},$e=["placeholder","inputmode","onKeydown"],xe={class:"icons"},Be={class:"content-container"},Le={key:0},Ae={key:0},Ke={key:0,class:"loading-container"},Ne={key:1,class:"empty-history"},Re={key:2},Ue={key:0,class:"no-results"},He={key:3,class:"search-prompt"},Oe={__name:"MovieSearch",setup(Y){const v=se(),y=oe(),d=ce(),n=u("title"),a=u(""),h=u([]),i=u(!1),p=u(!1),m=u(!1),l=u(""),f=u(null),k=u([]),_=u(!1),T=u(""),E=u(null);le(async()=>{if(y.token){i.value=!0;try{k.value=await me(H.HISTORY)}catch(t){const{message:e,code:s}=M(t);l.value=e,f.value=s,console.error("Ошибка загрузки истории:",t),s===401&&(y.logout(),await d.push("/login"),d.go(0))}finally{i.value=!1}}else k.value=v.history});function J(t){k.value=k.value.filter(e=>e.kp_id!==t)}const w=t=>{n.value=t,$(),_.value=!1},q=t=>{n.value==="title"?(a.value=t.target.value,_.value=fe(a.value),_.value&&(T.value=he(a.value))):a.value=t.target.value.replace(/\D+/g,"")},z=()=>{_.value&&(a.value=ge(a.value),_.value=!1)},j=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[n.value]||"Введите название фильма",$=()=>{a.value="",h.value=[],p.value=!1},x=()=>{B.cancel(),a.value?D():alert("Введите запрос для поиска")},D=async()=>{i.value=!0,p.value=!0,h.value=[];try{if(n.value==="kinopoisk"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,"")),d.push({name:"movie-info",params:{kp_id:a.value}});return}if(n.value==="imdb"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await ve(a.value);if(t.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="shikimori"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await de(a.value);if(t.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="title"){const t=await pe(a.value);h.value=t.map(e=>{var s,L,A;return{...e,kp_id:e.id.toString(),rating_kp:((s=e.raw_data)==null?void 0:s.rating)!=="null"?(L=e.raw_data)==null?void 0:L.rating:null,type:(A=e.raw_data)==null?void 0:A.type}})}}catch(t){const{message:e,code:s}=M(t);l.value=e,f.value=s,console.error("Ошибка при поиске:",t)}finally{i.value=!1}},G=async()=>{if(i.value=!0,y.token)try{await ye(H.HISTORY),k.value=[],i.value=!1,m.value=!1}catch(t){const{message:e,code:s}=M(t);l.value=e,f.value=s,console.error("Ошибка загрузки истории:",t),s===401&&(y.logout(),await d.push("/login"),d.go(0)),i.value=!1,m.value=!1}else v.clearAllHistory(),i.value=!1,m.value=!1},B=ne(()=>{a.value.length>=2?D():a.value.length<2&&(h.value=[],p.value=!1)},700);P(()=>{var e;const t=window.location.hash;if(t.startsWith("#search=")){const s=decodeURIComponent(t.replace("#search=",""));a.value=s,D()}else if(t.startsWith("#imdb=")){const s=decodeURIComponent(t.replace("#imdb=",""));w("imdb"),a.value=s,D()}else if(t.startsWith("#shiki")){const s=decodeURIComponent(t.replace("#shiki",""));w("shikimori"),a.value=s,D()}(e=E.value)==null||e.focus()}),re(a,()=>{n.value==="title"&&B()});const Q=()=>{if(h.value.length>0){const t=document.querySelector(".movie-card");t&&t.focus()}};return(t,e)=>(r(),c("div",Ce,[o("div",be,[o("div",Me,[o("button",{class:I({active:n.value==="title"}),onClick:e[0]||(e[0]=s=>w("title"))}," Название ",2),o("button",{class:I({active:n.value==="kinopoisk"}),onClick:e[1]||(e[1]=s=>w("kinopoisk"))}," ID Кинопоиск ",2),o("button",{class:I({active:n.value==="shikimori"}),onClick:e[2]||(e[2]=s=>w("shikimori"))}," ID Shikimori ",2),o("button",{class:I({active:n.value==="imdb"}),onClick:e[3]||(e[3]=s=>w("imdb"))}," ID IMDB ",2)]),o("div",Te,[o("div",Ee,[ie(o("input",{ref_key:"searchInput",ref:E,"onUpdate:modelValue":e[4]||(e[4]=s=>a.value=s),placeholder:j(),class:I(["search-input",{"wrong-layout":_.value}]),inputmode:n.value==="title"?"text":"numeric",onKeydown:[C(x,["enter"]),C(K(z,["prevent"]),["tab"]),C(K(Q,["prevent"]),["down"])],onInput:q},null,42,$e),[[ue,a.value]]),o("div",xe,[a.value?(r(),c("button",{key:0,class:"reset-button",onClick:$},e[7]||(e[7]=[o("i",{class:"fas fa-times"},null,-1)]))):g("",!0),o("button",{class:"search-button",onClick:x},e[8]||(e[8]=[o("i",{class:"fas fa-search"},null,-1)]))]),_.value?(r(),c("div",{key:0,class:I(["layout-warning",{show:_.value}])},[e[9]||(e[9]=o("i",{class:"fas fa-keyboard"},null,-1)),N(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+W(T.value)+" раскладку ",1)],2)):g("",!0)])]),o("div",Be,[a.value?g("",!0):(r(),c("div",Le,[o("h2",null,[e[10]||(e[10]=N(" История просмотра ")),k.value.length>0?(r(),c("span",Ae,[S(_e,{onClick:e[5]||(e[5]=s=>m.value=!0)}),S(ke,{"is-open":m.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:G,onClose:e[6]||(e[6]=s=>m.value=!1)},null,8,["is-open"])])):g("",!0)]),i.value?(r(),c("div",Ke,[S(we)])):k.value.length===0?(r(),c("div",Ne,e[11]||(e[11]=[o("span",{class:"material-icons"},"movie",-1),o("p",null,"Здесь пока пусто",-1)]))):(r(),b(R(O),{key:2,"movies-list":k.value,"is-history":!0,loading:!1,onItemDeleted:J},null,8,["movies-list"]))])),!a.value&&l.value?(r(),b(U,{key:1,message:l.value,code:f.value},null,8,["message","code"])):g("",!0),p.value?(r(),c("div",Re,[e[12]||(e[12]=o("h2",null,"Результаты поиска",-1)),S(R(O),{"movies-list":h.value,"is-history":!1,loading:i.value},null,8,["movies-list","loading"]),h.value.length===0&&!i.value&&!l.value?(r(),c("div",Ue," Ничего не найдено ")):g("",!0),l.value?(r(),b(U,{key:1,message:l.value,code:f.value},null,8,["message","code"])):g("",!0)])):g("",!0),a.value&&!p.value&&!i.value&&!l.value?(r(),c("div",He,' Нажмите кнопку "Поиск" или Enter для поиска ')):g("",!0)])]),S(De)]))}},We=V(Oe,[["__scopeId","data-v-50d14240"]]);export{We as default};
//# sourceMappingURL=MovieSearch-h48lJhTR.js.map
