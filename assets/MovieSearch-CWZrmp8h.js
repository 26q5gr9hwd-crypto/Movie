import{_ as V,r as u,c as P,o as W,a as ee,b as v,d as r,e as o,f as S,w as ae,g,t as Y,T as te,h as se,u as oe,i as le,j as ne,k as re,l as ie,n as I,m as ue,v as ce,p as C,q as K,s as N,x as M,y as R,E as U,z as ve,A as de,B as fe,C as pe,D as T,F as he,G as me,H as ge,U as H,I as ye,J as ke}from"./index-klDH-SlS.js";import{B as _e}from"./BaseModal-CdaK90Gs.js";import{D as we,M as O}from"./MovieList-vNLN8HAD.js";import{S as Ie}from"./SpinnerLoading-C71aZ6bw.js";const Se={class:"donaters-wrapper"},F="donatersCache",be={__name:"FooterDonaters",setup(J){const c=u([]),y=u(-1);let d=null;const n=P(()=>y.value===-1||!c.value.length?"":c.value[y.value]),t=async()=>{const f=new Date().toISOString().split("T")[0],m=localStorage.getItem(F);if(m)try{const{date:l,data:p}=JSON.parse(m);if(l===f){c.value=p;return}}catch(l){console.error("Ошибка кэша донатеров:",l)}try{const l=await se();c.value=l.split("\n").map(p=>p.trim()).filter(p=>p),localStorage.setItem(F,JSON.stringify({date:f,data:c.value}))}catch(l){console.error("Ошибка загрузки донатеров:",l)}};function h(){if(!c.value.length)return;const f=Math.floor(Math.random()*c.value.length);y.value=f}function i(){c.value.length!==0&&(h(),d=setInterval(h,4e3))}return W(async()=>{await t(),i()}),ee(()=>{d&&clearInterval(d)}),(f,m)=>(r(),v("footer",null,[o("div",Se,[S(te,{name:"fade",mode:"out-in"},{default:ae(()=>[n.value?(r(),v("span",{key:y.value,class:"donater"},Y(n.value),1)):g("",!0)]),_:1})])]))}},De=V(be,[["__scopeId","data-v-5dec4e96"]]),Ce={class:"wrapper"},Me={class:"mainpage"},Te={class:"search-type-buttons"},Ee={class:"search-container"},$e={class:"input-wrapper"},xe=["placeholder","inputmode","onKeydown"],Be={class:"icons"},Le={class:"content-container"},Ae={key:0},Ke={key:0},Ne={key:0,class:"loading-container"},Re={key:1,class:"empty-history"},Ue={key:2},He={key:0,class:"no-results"},Oe={key:3,class:"search-prompt"},Fe={__name:"MovieSearch",setup(J){const c=oe(),y=le(),d=ve(),n=u("title"),t=u(""),h=u([]),i=u(!1),f=u(!1),m=u(!1),l=u(""),p=u(null),q=P(()=>c.isMobile),_=u([]),k=u(!1),E=u(""),D=u(null);ne(async()=>{if(y.token){i.value=!0;try{_.value=await ge(H.HISTORY)}catch(a){const{message:e,code:s}=T(a);l.value=e,p.value=s,console.error("Ошибка загрузки истории:",a),s===401&&(y.logout(),await d.push("/login"),d.go(0))}finally{i.value=!1}}else _.value=c.history});function z(a){_.value=_.value.filter(e=>e.kp_id!==a)}const w=a=>{n.value=a,$(),k.value=!1},j=a=>{if(n.value==="title"){if(t.value=a.target.value,q.value)return;k.value=he(t.value),k.value&&(E.value=me(t.value))}else t.value=a.target.value.replace(/\D+/g,"")},G=()=>{k.value&&(t.value=ye(t.value),k.value=!1)},Q=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[n.value]||"Введите название фильма",$=()=>{var a;t.value="",h.value=[],f.value=!1,k.value=!1,(a=D.value)==null||a.focus()},x=()=>{B.cancel(),t.value?b():alert("Введите запрос для поиска")},b=async()=>{i.value=!0,f.value=!0,h.value=[];try{if(n.value==="kinopoisk"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,"")),d.push({name:"movie-info",params:{kp_id:t.value}});return}if(n.value==="imdb"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,""));const a=await de(t.value);if(a.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="shikimori"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,""));const a=await fe(t.value);if(a.id_kp)d.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="title"){const a=await pe(t.value);h.value=a.map(e=>{var s,L,A;return{...e,kp_id:e.id.toString(),rating_kp:((s=e.raw_data)==null?void 0:s.rating)!=="null"?(L=e.raw_data)==null?void 0:L.rating:null,type:(A=e.raw_data)==null?void 0:A.type}})}}catch(a){const{message:e,code:s}=T(a);l.value=e,p.value=s,console.error("Ошибка при поиске:",a)}finally{i.value=!1}},X=async()=>{if(i.value=!0,y.token)try{await ke(H.HISTORY),_.value=[],i.value=!1,m.value=!1}catch(a){const{message:e,code:s}=T(a);l.value=e,p.value=s,console.error("Ошибка загрузки истории:",a),s===401&&(y.logout(),await d.push("/login"),d.go(0)),i.value=!1,m.value=!1}else c.clearAllHistory(),i.value=!1,m.value=!1},B=re(()=>{t.value.length>=2?b():t.value.length<2&&(h.value=[],f.value=!1)},700);W(()=>{var e;const a=window.location.hash;if(a.startsWith("#search=")){const s=decodeURIComponent(a.replace("#search=",""));t.value=s,b()}else if(a.startsWith("#imdb=")){const s=decodeURIComponent(a.replace("#imdb=",""));w("imdb"),t.value=s,b()}else if(a.startsWith("#shiki")){const s=decodeURIComponent(a.replace("#shiki",""));w("shikimori"),t.value=s,b()}(e=D.value)==null||e.focus()}),ie(t,()=>{n.value==="title"&&B()});const Z=()=>{if(h.value.length>0){const a=document.querySelector(".movie-card");a&&a.focus()}};return(a,e)=>(r(),v("div",Ce,[o("div",Me,[o("div",Te,[o("button",{class:I({active:n.value==="title"}),onClick:e[0]||(e[0]=s=>w("title"))}," Название ",2),o("button",{class:I({active:n.value==="kinopoisk"}),onClick:e[1]||(e[1]=s=>w("kinopoisk"))}," ID Кинопоиск ",2),o("button",{class:I({active:n.value==="shikimori"}),onClick:e[2]||(e[2]=s=>w("shikimori"))}," ID Shikimori ",2),o("button",{class:I({active:n.value==="imdb"}),onClick:e[3]||(e[3]=s=>w("imdb"))}," ID IMDB ",2)]),o("div",Ee,[o("div",$e,[ue(o("input",{ref_key:"searchInput",ref:D,"onUpdate:modelValue":e[4]||(e[4]=s=>t.value=s),placeholder:Q(),class:I(["search-input",{"wrong-layout":k.value}]),inputmode:n.value==="title"?"text":"numeric",onKeydown:[C(x,["enter"]),C(K(G,["prevent"]),["tab"]),C(K(Z,["prevent"]),["down"])],onInput:j},null,42,xe),[[ce,t.value]]),o("div",Be,[t.value?(r(),v("button",{key:0,class:"reset-button",onClick:$},e[7]||(e[7]=[o("i",{class:"fas fa-times"},null,-1)]))):g("",!0),o("button",{class:"search-button",onClick:x},e[8]||(e[8]=[o("i",{class:"fas fa-search"},null,-1)]))]),k.value?(r(),v("div",{key:0,class:I(["layout-warning",{show:k.value}])},[e[9]||(e[9]=o("i",{class:"fas fa-keyboard"},null,-1)),N(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+Y(E.value)+" раскладку ",1)],2)):g("",!0)])]),o("div",Le,[t.value?g("",!0):(r(),v("div",Ae,[o("h2",null,[e[10]||(e[10]=N(" История просмотра ")),_.value.length>0?(r(),v("span",Ke,[S(we,{onClick:e[5]||(e[5]=s=>m.value=!0)}),S(_e,{"is-open":m.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:X,onClose:e[6]||(e[6]=s=>m.value=!1)},null,8,["is-open"])])):g("",!0)]),i.value?(r(),v("div",Ne,[S(Ie)])):_.value.length===0?(r(),v("div",Re,e[11]||(e[11]=[o("span",{class:"material-icons"},"movie",-1),o("p",null,"Здесь пока пусто",-1)]))):(r(),M(R(O),{key:2,"movies-list":_.value,"is-history":!0,loading:!1,onItemDeleted:z},null,8,["movies-list"]))])),!t.value&&l.value?(r(),M(U,{key:1,message:l.value,code:p.value},null,8,["message","code"])):g("",!0),f.value?(r(),v("div",Ue,[e[12]||(e[12]=o("h2",null,"Результаты поиска",-1)),S(R(O),{"movies-list":h.value,"is-history":!1,loading:i.value},null,8,["movies-list","loading"]),h.value.length===0&&!i.value&&!l.value?(r(),v("div",He," Ничего не найдено ")):g("",!0),l.value?(r(),M(U,{key:1,message:l.value,code:p.value},null,8,["message","code"])):g("",!0)])):g("",!0),t.value&&!f.value&&!i.value&&!l.value?(r(),v("div",Oe,' Нажмите кнопку "Поиск" или Enter для поиска ')):g("",!0)])]),S(De)]))}},Je=V(Fe,[["__scopeId","data-v-1ebf1967"]]);export{Je as default};
