import{_ as ee,r as y,c as X,o as de,a as fe,b as n,d as e,e as H,w as Y,T as Z,F as he,f as ge,n as U,g as ye,h as ke,i as o,j as v,k as pe,t as b,l as S,m as W,p as we,q as _e,s as J,u as me,v as Ie,x as be,y as Ce,z as De,A as Se,B as $e,C as Q,D as se,E as oe,G as Me,H as Le,I as Te,J as xe,K as z,L as Ee,M as Ue,N as Fe,O as He,U as le,P as Re,Q as Ne}from"./index-DD3gcM78.js";import{B as Oe}from"./BaseModal-DTE1EpFp.js";import{D as Ae,M as ne}from"./MovieList-CY7_llfx.js";import{S as Be}from"./SpinnerLoading-SAr3XGIP.js";import{_ as Ke,a as ie,b as re}from"./icon-imdb-logo-5qtstUwS.js";const Ve={class:"donaters-wrapper"},We={class:"top-donators-carousel"},ze=["href","target","rel"],Je={class:"donor-card-preview"},Ye={key:0,class:"avatar-placeholder"},Pe={key:1,class:"live-badge"},qe={class:"donor-card-info"},Ge={class:"donor-name"},je={key:0,class:"donor-category"},Qe={key:1,class:"donor-status"},Xe={key:2,class:"donor-status offline"},Ze={key:0,class:"donor-link-icon"},et={class:"carousel-indicators"},tt=["onClick"],ue="donatersCache",ce="twitchDataCache",ve=300*1e3,at={__name:"FooterDonaters",setup(i){const C=y([]),L=y(-1),g=y(0),w=y(!1);let s=null,I=null,h=null,l={donaters:null,twitch:null},T=!1;const d=y([{name:"XaksFlaX",twitchUsername:"xaksflax",avatar:null,isLive:!1,category:null,originalIndex:0},{name:"TanyaBelkova",twitchUsername:"tanyabelkova",avatar:null,isLive:!1,category:null,originalIndex:1},{name:"F1ashko",twitchUsername:"f1ashko",avatar:null,isLive:!1,category:null,originalIndex:2},{name:"Krabick",twitchUsername:"krabick",avatar:null,isLive:!1,category:null,originalIndex:3},{name:"Kati",twitchUsername:"Kati",avatar:null,isLive:!1,category:null,originalIndex:4},{name:"Timofey",twitchUsername:"Timofey",avatar:null,isLive:!1,category:null,originalIndex:5}]),x=X(()=>L.value===-1||!C.value.length?"":C.value[L.value]),k=X(()=>d.value.length?d.value[g.value]:null);let D=null;const $=()=>{D||(D=window.requestAnimationFrame(()=>{const p=window.pageYOffset||document.documentElement.scrollTop,u=window.innerHeight,r=document.documentElement.scrollHeight;w.value=p+u>=r-10,D=null}))},K=(p,u)=>{try{return localStorage.getItem(p)}catch(r){return console.warn("localStorage error: ".concat(r.message)),l[u]?JSON.stringify(l[u]):null}},N=(p,u,r)=>{try{localStorage.setItem(p,u)}catch(f){console.warn("localStorage error: ".concat(f.message));try{l[r]=JSON.parse(u)}catch(c){console.error("safeSaveToStorage:",c)}}},O=async()=>{if(T)return;const p=K(ce,"twitch");if(p)try{const{timestamp:r,data:f}=JSON.parse(p);if(Date.now()-r<ve){F(f);return}}catch(r){console.error("fetchTwitchData:",r)}const u=d.value.filter(r=>r.twitchUsername).map(r=>r.twitchUsername);if(u.length!==0){T=!0;try{const r=u.map(async _=>{try{const M=await ke(_);if(!M||!M.user_info)return{username:_,isLive:!1,category:null,avatar:null};const R=M.user_info.avatar_url||null;if(M.stream_data&&M.stream_data.length>0){const a=M.stream_data[0];return{username:_,isLive:!0,category:a.game_name||null,avatar:R}}else return{username:_,isLive:!1,category:null,avatar:R}}catch(M){return console.error("Twitch error for ".concat(_,":"),M),{username:_,isLive:!1,category:null,avatar:null}}}),f=await Promise.all(r),c=JSON.stringify({timestamp:Date.now(),data:f});N(ce,c,"twitch"),F(f)}catch(r){console.error("fetchTwitchData:",r)}finally{T=!1}}},F=p=>{const u=new Map(p.map(c=>[c.username.toLowerCase(),c]));let r=!1;const f=d.value.map(c=>{if(!c.twitchUsername)return c;const _=u.get(c.twitchUsername.toLowerCase());if(_){const M=_.isLive||!1,V=_.category||null,R=_.avatar||c.avatar;if(c.isLive!==M||c.category!==V||c.avatar!==R)return r=!0,{...c,isLive:M,category:V,avatar:R}}return c});r&&(f.sort((c,_)=>c.isLive!==_.isLive?c.isLive?-1:1:c.originalIndex-_.originalIndex),d.value=f,g.value=0)},A=async()=>{const p=new Date().toISOString().split("T")[0],u=K(ue,"donaters");if(u)try{const{date:r,data:f}=JSON.parse(u);if(r===p){C.value=f;return}}catch(r){console.error("fetchDonaters:",r)}try{const r=await ye();C.value=r.split("\n").map(c=>c.trim()).filter(c=>c);const f=JSON.stringify({date:p,data:C.value});N(ue,f,"donaters")}catch(r){console.error("Ошибка загрузки донатеров:",r)}};function B(){if(!C.value.length)return;const p=Math.floor(Math.random()*C.value.length);L.value=p}function P(){C.value.length!==0&&(B(),s=setInterval(B,4e3))}function E(){d.value.length&&(g.value=(g.value+1)%d.value.length)}function q(p){g.value=p,I&&(clearInterval(I),I=setInterval(E,5e3))}function G(){d.value.length!==0&&(I=setInterval(E,5e3))}return de(async()=>{await A(),P(),G(),window.addEventListener("scroll",$,{passive:!0}),$(),await O(),h=setInterval(O,ve)}),fe(()=>{s&&clearInterval(s),I&&clearInterval(I),h&&clearInterval(h),D&&window.cancelAnimationFrame(D),window.removeEventListener("scroll",$)}),(p,u)=>(o(),n("footer",{class:U({"footer-fixed":!w.value,"footer-static":w.value})},[e("div",Ve,[u[2]||(u[2]=e("span",{class:"donaters-text"},"Спасибо топ донатерам",-1)),e("div",We,[H(Z,{name:"fade",mode:"out-in"},{default:Y(()=>[k.value?(o(),n("a",{key:g.value,href:k.value.twitchUsername?"https://twitch.tv/".concat(k.value.twitchUsername):void 0,target:k.value.twitchUsername?"_blank":void 0,rel:k.value.twitchUsername?"noopener noreferrer":void 0,class:U(["donor-card",{"is-live":k.value.isLive,"no-link":!k.value.twitchUsername}])},[e("div",Je,[e("div",{class:"donor-avatar",style:pe({backgroundImage:k.value.avatar?"url(".concat(k.value.avatar,")"):"linear-gradient(135deg, #9147ff 0%, #5a1f99 100%)"})},[k.value.avatar?v("",!0):(o(),n("div",Ye,b(k.value.name.charAt(0).toUpperCase()),1)),k.value.isLive?(o(),n("div",Pe,u[0]||(u[0]=[e("span",{class:"live-indicator"},null,-1),S(" LIVE ")]))):v("",!0)],4)]),e("div",qe,[e("div",Ge,b(k.value.name),1),k.value.isLive&&k.value.category?(o(),n("div",je,b(k.value.category),1)):k.value.isLive?(o(),n("div",Qe,"В эфире")):(o(),n("div",Xe,"Не в сети"))]),k.value.twitchUsername?(o(),n("div",Ze,u[1]||(u[1]=[e("svg",{viewBox:"0 0 24 24",fill:"currentColor",width:"14",height:"14"},[e("path",{d:"M11.571 4.714h1.715v5.143H11.57zm4.715 0H18v5.143h-1.714zM6 0L1.714 4.286v15.428h5.143V24l4.286-4.286h3.428L22.286 12V0zm14.571 11.143l-3.428 3.428h-3.429l-3 3v-3H6.857V1.714h13.714Z"})],-1)]))):v("",!0)],10,ze)):v("",!0)]),_:1}),e("div",et,[(o(!0),n(he,null,ge(d.value,(r,f)=>(o(),n("button",{key:f,class:U({active:f===g.value}),onClick:c=>q(f)},null,10,tt))),128))])]),u[3]||(u[3]=e("span",{class:"donaters-text"},"а так же",-1)),H(Z,{name:"fade",mode:"out-in"},{default:Y(()=>[x.value?(o(),n("span",{key:L.value,class:"donater"},b(x.value),1)):v("",!0)]),_:1})])],2))}},st=ee(at,[["__scopeId","data-v-be0950a5"]]),ot={class:"modal modern-dark-dialog random-movie-modal"},lt={class:"modal-content"},nt={key:0,class:"loading-container"},it={key:1,class:"movie-content"},rt={class:"movie-poster-section"},ut=["alt"],ct={class:"movie-info-section"},vt={class:"movie-title"},dt={key:0,class:"movie-year"},mt={key:1,class:"movie-type"},ft={key:2,class:"movie-countries"},ht={key:3,class:"movie-genres"},gt={class:"ratings"},yt={key:0,class:"rating rating-our"},kt={key:1,class:"rating rating-kp"},pt={key:2,class:"rating rating-imdb"},wt={class:"external-links"},_t=["href"],It=["href"],bt={key:2,class:"error-content"},Ct={class:"modal-actions"},Dt=["disabled"],St={__name:"RandomMovieModal",props:{isOpen:Boolean,movie:Object,loading:Boolean,error:String},emits:["close","get-new-movie"],setup(i,{emit:C}){const L=C,g=()=>{L("close")},w=()=>{L("get-new-movie")},s=h=>({"FilmType.FILM":"Фильм","FilmType.TV_SERIES":"Сериал","FilmType.TV_SHOW":"ТВ-шоу","FilmType.MINI_SERIES":"Мини-сериал"})[h]||h,I=h=>{h.target.src="/src/assets/image-no-poster.gif"};return(h,l)=>{const T=we("router-link"),d=_e("lazy");return o(),W(Z,{name:"modal"},{default:Y(()=>[i.isOpen?(o(),n("div",{key:0,class:"modal-overlay",onClick:J(g,["self"])},[e("div",ot,[e("div",{class:"modal-header"},[l[1]||(l[1]=e("h3",null,[e("i",{class:"fas fa-dice"}),S(" Случайный фильм ")],-1)),e("button",{class:"close-btn",onClick:g},l[0]||(l[0]=[e("i",{class:"fas fa-times"},null,-1)]))]),e("div",lt,[i.loading?(o(),n("div",nt,l[2]||(l[2]=[e("div",{class:"spinner"},null,-1),e("p",null,"Подбираем фильм...",-1)]))):i.movie?(o(),n("div",it,[e("div",rt,[me(e("img",{alt:i.movie.title,class:"movie-poster",onError:I},null,40,ut),[[d,i.movie.cover]])]),e("div",ct,[e("h4",vt,b(i.movie.title),1),i.movie.year?(o(),n("div",dt,b(i.movie.year),1)):v("",!0),i.movie.type?(o(),n("div",mt,b(s(i.movie.type)),1)):v("",!0),i.movie.countries?(o(),n("div",ft,[l[3]||(l[3]=e("strong",null,"Страны:",-1)),S(" "+b(i.movie.countries),1)])):v("",!0),i.movie.genres?(o(),n("div",ht,[l[4]||(l[4]=e("strong",null,"Жанры:",-1)),S(" "+b(i.movie.genres),1)])):v("",!0),e("div",gt,[i.movie.rating_reyohoho?(o(),n("div",yt,[l[5]||(l[5]=e("img",{src:Ke,alt:"ReYohoho",class:"rating-logo"},null,-1)),S(" "+b(i.movie.rating_reyohoho.toFixed(1)),1)])):v("",!0),i.movie.rating_kp?(o(),n("div",kt,[l[6]||(l[6]=e("img",{src:ie,alt:"КП",class:"rating-logo"},null,-1)),S(" "+b(i.movie.rating_kp),1)])):v("",!0),i.movie.rating_imdb?(o(),n("div",pt,[l[7]||(l[7]=e("img",{src:re,alt:"IMDb",class:"rating-logo"},null,-1)),S(" "+b(i.movie.rating_imdb),1)])):v("",!0)]),e("div",wt,[i.movie.url_kp?(o(),n("a",{key:0,href:i.movie.url_kp,target:"_blank",class:"external-link"},l[8]||(l[8]=[e("img",{src:ie,alt:"КП"},null,-1),S(" Кинопоиск ")]),8,_t)):v("",!0),i.movie.url_imdb?(o(),n("a",{key:1,href:i.movie.url_imdb,target:"_blank",class:"external-link"},l[9]||(l[9]=[e("img",{src:re,alt:"IMDb"},null,-1),S(" IMDb ")]),8,It)):v("",!0)])])])):i.error?(o(),n("div",bt,[l[10]||(l[10]=e("i",{class:"fas fa-exclamation-triangle"},null,-1)),e("p",null,b(i.error),1)])):v("",!0)]),e("div",Ct,[e("button",{class:"modern-dark-btn",onClick:g},"Закрыть"),i.movie&&!i.loading?(o(),W(T,{key:0,to:{name:"movie-info",params:{kp_id:i.movie.kp_id}},class:"modern-dark-btn primary",onClick:g},{default:Y(()=>l[11]||(l[11]=[S(" Посмотреть ")])),_:1},8,["to"])):v("",!0),e("button",{class:"modern-dark-btn primary",disabled:i.loading,onClick:w},l[12]||(l[12]=[e("i",{class:"fas fa-dice"},null,-1),S(" Еще раз ")]),8,Dt)])])])):v("",!0)]),_:1})}}},$t=ee(St,[["__scopeId","data-v-ab41b1b2"]]),Mt={class:"wrapper"},Lt={class:"mainpage"},Tt={class:"search-type-buttons"},xt=["disabled"],Et={class:"search-container"},Ut={class:"input-wrapper"},Ft=["placeholder","inputmode","onKeydown"],Ht={class:"icons"},Rt={class:"content-container"},Nt={key:0},Ot={key:0},At={key:0,class:"loading-container"},Bt={key:1,class:"empty-history"},Kt={key:2},Vt={key:0,class:"no-results"},Wt={key:3,class:"search-prompt"},zt={__name:"MovieSearch",setup(i){const C=Ie(),L=be(),g=Me(),w=y("title"),s=y(""),I=y([]),h=y(!1),l=y(!1),T=y(!1),d=y(""),x=y(null),k=X(()=>C.isMobile),D=y([]),$=y(!1),K=y(""),N=y(!1),O=y(null),F=y(!1),A=y(""),B=y(null);Ce(async()=>{if(L.token){h.value=!0;try{D.value=await He(le.HISTORY)}catch(a){const{message:t,code:m}=z(a);d.value=t,x.value=m,console.error("Ошибка загрузки истории:",a),m===401&&(L.logout(),await g.push("/login"),g.go(0))}finally{h.value=!1}}else D.value=C.history});function P(a){D.value=D.value.filter(t=>t.kp_id!==a)}const E=a=>{w.value=a,u(),$.value=!1},q=a=>{if(d.value="",x.value=null,w.value==="title"){if(s.value=a.target.value,k.value)return;$.value=Ee(s.value),$.value&&(K.value=Ue(s.value))}else s.value=a.target.value.replace(/\D+/g,"")},G=()=>{$.value&&(s.value=Re(s.value),$.value=!1)},p=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[w.value]||"Введите название фильма",u=()=>{var a;s.value="",I.value=[],l.value=!1,$.value=!1,d.value="",x.value=null,(a=B.value)==null||a.focus()},r=()=>{_.cancel(),s.value&&(d.value="",x.value=null,f())},f=async()=>{h.value=!0,l.value=!0,I.value=[];try{if(w.value==="kinopoisk"){/^\d+$/.test(s.value)||(s.value=s.value.replace(/\D/g,"")),g.push({name:"movie-info",params:{kp_id:s.value}});return}if(w.value==="imdb"){/^\d+$/.test(s.value)||(s.value=s.value.replace(/\D/g,""));const a=await Le(s.value);if(a.id_kp)g.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});else throw new Error("Не найдено");return}if(w.value==="shikimori"){/^\d+$/.test(s.value)||(s.value=s.value.replace(/\D/g,""));try{const a=await Te(s.value);if(a.id_kp){g.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});return}}catch(a){console.log("Switch to kodik",a)}g.push({name:"movie-info-shiki",params:{shiki_id:"shiki".concat(s.value)}});return}if(w.value==="title"){const a=await xe(s.value);I.value=a.map(t=>{var m,te,ae;return{...t,kp_id:t.id.toString(),rating_kp:((m=t.raw_data)==null?void 0:m.rating)!=="null"?(te=t.raw_data)==null?void 0:te.rating:null,type:(ae=t.raw_data)==null?void 0:ae.type}})}}catch(a){const{message:t,code:m}=z(a);d.value=t,x.value=m,console.error("Ошибка при поиске:",a)}finally{h.value=!1}},c=async()=>{if(h.value=!0,L.token)try{await Ne(le.HISTORY),D.value=[],h.value=!1,T.value=!1}catch(a){const{message:t,code:m}=z(a);d.value=t,x.value=m,console.error("Ошибка загрузки истории:",a),m===401&&(L.logout(),await g.push("/login"),g.go(0)),h.value=!1,T.value=!1}else C.clearAllHistory(),h.value=!1,T.value=!1},_=De(()=>{s.value.length>=2?f():s.value.length<2&&(I.value=[],l.value=!1)},700);de(()=>{var t;const a=window.location.hash;if(a.startsWith("#search=")){const m=decodeURIComponent(a.replace("#search=",""));s.value=m,f()}else if(a.startsWith("#imdb=")){const m=decodeURIComponent(a.replace("#imdb=",""));E("imdb"),s.value=m,f()}else if(a.startsWith("#shiki")){const m=decodeURIComponent(a.replace("#shiki",""));E("shikimori"),s.value=m,f()}(t=B.value)==null||t.focus()}),Se(s,()=>{w.value==="title"&&_()});const M=()=>{if(I.value.length>0){const a=document.querySelector(".movie-card");a&&a.focus()}},V=()=>{N.value=!0,j()},R=()=>{N.value=!1,O.value=null,A.value=""},j=async()=>{F.value=!0,A.value="";try{const a=await Fe();O.value=a}catch(a){const{message:t}=z(a);A.value=t,console.error("Ошибка при получении случайного фильма:",a)}finally{F.value=!1}};return(a,t)=>(o(),n("div",Mt,[e("div",Lt,[e("div",Tt,[e("button",{class:U({active:w.value==="title"}),onClick:t[0]||(t[0]=m=>E("title"))}," Название ",2),e("button",{class:U({active:w.value==="kinopoisk"}),onClick:t[1]||(t[1]=m=>E("kinopoisk"))}," ID Кинопоиск ",2),e("button",{class:U({active:w.value==="shikimori"}),onClick:t[2]||(t[2]=m=>E("shikimori"))}," ID Shikimori ",2),e("button",{class:U({active:w.value==="imdb"}),onClick:t[3]||(t[3]=m=>E("imdb"))}," ID IMDB ",2),e("button",{class:"random-button",onClick:V,disabled:F.value},[t[7]||(t[7]=e("i",{class:"fas fa-dice"},null,-1)),S(" "+b(F.value?"Подбираем...":"Случайный фильм"),1)],8,xt)]),e("div",Et,[e("div",Ut,[me(e("input",{ref_key:"searchInput",ref:B,"onUpdate:modelValue":t[4]||(t[4]=m=>s.value=m),placeholder:p(),class:U(["search-input",{"wrong-layout":$.value}]),inputmode:w.value==="title"?"text":"numeric",onKeydown:[Q(J(r,["prevent"]),["enter"]),Q(J(G,["prevent"]),["tab"]),Q(J(M,["prevent"]),["down"])],onInput:q},null,42,Ft),[[$e,s.value]]),e("div",Ht,[s.value?(o(),n("button",{key:0,class:"reset-button",onClick:u},t[8]||(t[8]=[e("i",{class:"fas fa-times"},null,-1)]))):v("",!0),e("button",{class:"search-button",onClick:r},t[9]||(t[9]=[e("i",{class:"fas fa-search"},null,-1)]))]),$.value?(o(),n("div",{key:0,class:U(["layout-warning",{show:$.value}])},[t[10]||(t[10]=e("i",{class:"fas fa-keyboard"},null,-1)),S(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+b(K.value)+" раскладку ",1)],2)):v("",!0)])]),e("div",Rt,[s.value?v("",!0):(o(),n("div",Nt,[e("h2",null,[t[11]||(t[11]=S(" История просмотра ")),D.value.length>0?(o(),n("span",Ot,[H(Ae,{onClick:t[5]||(t[5]=m=>T.value=!0)}),H(Oe,{"is-open":T.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:c,onClose:t[6]||(t[6]=m=>T.value=!1)},null,8,["is-open"])])):v("",!0)]),h.value?(o(),n("div",At,[H(Be)])):D.value.length===0?(o(),n("div",Bt,t[12]||(t[12]=[e("span",{class:"material-icons"},"movie",-1),e("p",null,"Здесь пока пусто",-1)]))):(o(),W(se(ne),{key:2,"movies-list":D.value,"is-history":!0,loading:!1,onItemDeleted:P},null,8,["movies-list"]))])),!s.value&&d.value?(o(),W(oe,{key:1,message:d.value,code:x.value},null,8,["message","code"])):v("",!0),l.value?(o(),n("div",Kt,[t[13]||(t[13]=e("h2",null,"Результаты поиска",-1)),H(se(ne),{"movies-list":I.value,"is-history":!1,loading:h.value},null,8,["movies-list","loading"]),I.value.length===0&&!h.value&&!d.value?(o(),n("div",Vt," Ничего не найдено ")):v("",!0),d.value?(o(),W(oe,{key:1,message:d.value,code:x.value},null,8,["message","code"])):v("",!0)])):v("",!0),s.value&&!l.value&&!h.value&&!d.value?(o(),n("div",Wt,' Нажмите кнопку "Поиск" или Enter для поиска ')):v("",!0)])]),H(st),H($t,{"is-open":N.value,movie:O.value,loading:F.value,error:A.value,onClose:R,onGetNewMovie:j},null,8,["is-open","movie","loading","error"])]))}},jt=ee(zt,[["__scopeId","data-v-05c02d79"]]);export{jt as default};
