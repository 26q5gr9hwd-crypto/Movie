import{_ as Y,r as i,c as P,o as W,a as ee,b as f,d as r,e as l,f as b,w as ae,g,t as J,T as te,n as I,h as se,u as oe,i as le,j as ne,k as re,l as ie,m as ue,v as ce,p as M,q as E,s as N,x as T,y as R,E as U,z as ve,A as de,B as fe,C as pe,D as $,F as me,G as he,H as ge,U as O,I as ye,J as ke}from"./index-CxxHjsem.js";import{B as we}from"./BaseModal-Bfs4F_cv.js";import{D as _e,M as F}from"./MovieList-Ds41RiCs.js";import{S as Ie}from"./SpinnerLoading-iU9sn3zM.js";const Se={class:"donaters-wrapper"},V="donatersCache",be={__name:"FooterDonaters",setup(q){const d=i([]),y=i(-1),p=i(!1);let n=null;const t=P(()=>y.value===-1||!d.value.length?"":d.value[y.value]),m=()=>{const o=window.pageYOffset||document.documentElement.scrollTop,c=window.innerHeight,h=document.documentElement.scrollHeight;p.value=o+c>=h-10},u=async()=>{const o=new Date().toISOString().split("T")[0],c=localStorage.getItem(V);if(c)try{const{date:h,data:v}=JSON.parse(c);if(h===o){d.value=v;return}}catch(h){console.error("Ошибка кэша донатеров:",h)}try{const h=await se();d.value=h.split("\n").map(v=>v.trim()).filter(v=>v),localStorage.setItem(V,JSON.stringify({date:o,data:d.value}))}catch(h){console.error("Ошибка загрузки донатеров:",h)}};function w(){if(!d.value.length)return;const o=Math.floor(Math.random()*d.value.length);y.value=o}function _(){d.value.length!==0&&(w(),n=setInterval(w,4e3))}return W(async()=>{await u(),_(),window.addEventListener("scroll",m),m()}),ee(()=>{n&&clearInterval(n),window.removeEventListener("scroll",m)}),(o,c)=>(r(),f("footer",{class:I({"footer-fixed":!p.value,"footer-static":p.value})},[l("div",Se,[b(te,{name:"fade",mode:"out-in"},{default:ae(()=>[t.value?(r(),f("span",{key:y.value,class:"donater"},J(t.value),1)):g("",!0)]),_:1})])],2))}},De=Y(be,[["__scopeId","data-v-1babf189"]]),Ce={class:"wrapper"},Me={class:"mainpage"},Ee={class:"search-type-buttons"},Te={class:"search-container"},$e={class:"input-wrapper"},xe=["placeholder","inputmode","onKeydown"],Be={class:"icons"},He={class:"content-container"},Le={key:0},Ae={key:0},Ke={key:0,class:"loading-container"},Ne={key:1,class:"empty-history"},Re={key:2},Ue={key:0,class:"no-results"},Oe={key:3,class:"search-prompt"},Fe={__name:"MovieSearch",setup(q){const d=oe(),y=le(),p=ve(),n=i("title"),t=i(""),m=i([]),u=i(!1),w=i(!1),_=i(!1),o=i(""),c=i(null),h=P(()=>d.isMobile),v=i([]),k=i(!1),x=i(""),C=i(null);ne(async()=>{if(y.token){u.value=!0;try{v.value=await ge(O.HISTORY)}catch(a){const{message:e,code:s}=$(a);o.value=e,c.value=s,console.error("Ошибка загрузки истории:",a),s===401&&(y.logout(),await p.push("/login"),p.go(0))}finally{u.value=!1}}else v.value=d.history});function z(a){v.value=v.value.filter(e=>e.kp_id!==a)}const S=a=>{n.value=a,B(),k.value=!1},j=a=>{if(o.value="",c.value=null,n.value==="title"){if(t.value=a.target.value,h.value)return;k.value=me(t.value),k.value&&(x.value=he(t.value))}else t.value=a.target.value.replace(/\D+/g,"")},G=()=>{k.value&&(t.value=ye(t.value),k.value=!1)},Q=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[n.value]||"Введите название фильма",B=()=>{var a;t.value="",m.value=[],w.value=!1,k.value=!1,o.value="",c.value=null,(a=C.value)==null||a.focus()},H=()=>{L.cancel(),t.value&&(o.value="",c.value=null,D())},D=async()=>{u.value=!0,w.value=!0,m.value=[];try{if(n.value==="kinopoisk"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,"")),p.push({name:"movie-info",params:{kp_id:t.value}});return}if(n.value==="imdb"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,""));const a=await de(t.value);if(a.id_kp)p.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="shikimori"){/^\d+$/.test(t.value)||(t.value=t.value.replace(/\D/g,""));const a=await fe(t.value);if(a.id_kp)p.push({name:"movie-info",params:{kp_id:"".concat(a.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="title"){const a=await pe(t.value);m.value=a.map(e=>{var s,A,K;return{...e,kp_id:e.id.toString(),rating_kp:((s=e.raw_data)==null?void 0:s.rating)!=="null"?(A=e.raw_data)==null?void 0:A.rating:null,type:(K=e.raw_data)==null?void 0:K.type}})}}catch(a){const{message:e,code:s}=$(a);o.value=e,c.value=s,console.error("Ошибка при поиске:",a)}finally{u.value=!1}},X=async()=>{if(u.value=!0,y.token)try{await ke(O.HISTORY),v.value=[],u.value=!1,_.value=!1}catch(a){const{message:e,code:s}=$(a);o.value=e,c.value=s,console.error("Ошибка загрузки истории:",a),s===401&&(y.logout(),await p.push("/login"),p.go(0)),u.value=!1,_.value=!1}else d.clearAllHistory(),u.value=!1,_.value=!1},L=re(()=>{t.value.length>=2?D():t.value.length<2&&(m.value=[],w.value=!1)},700);W(()=>{var e;const a=window.location.hash;if(a.startsWith("#search=")){const s=decodeURIComponent(a.replace("#search=",""));t.value=s,D()}else if(a.startsWith("#imdb=")){const s=decodeURIComponent(a.replace("#imdb=",""));S("imdb"),t.value=s,D()}else if(a.startsWith("#shiki")){const s=decodeURIComponent(a.replace("#shiki",""));S("shikimori"),t.value=s,D()}(e=C.value)==null||e.focus()}),ie(t,()=>{n.value==="title"&&L()});const Z=()=>{if(m.value.length>0){const a=document.querySelector(".movie-card");a&&a.focus()}};return(a,e)=>(r(),f("div",Ce,[l("div",Me,[l("div",Ee,[l("button",{class:I({active:n.value==="title"}),onClick:e[0]||(e[0]=s=>S("title"))}," Название ",2),l("button",{class:I({active:n.value==="kinopoisk"}),onClick:e[1]||(e[1]=s=>S("kinopoisk"))}," ID Кинопоиск ",2),l("button",{class:I({active:n.value==="shikimori"}),onClick:e[2]||(e[2]=s=>S("shikimori"))}," ID Shikimori ",2),l("button",{class:I({active:n.value==="imdb"}),onClick:e[3]||(e[3]=s=>S("imdb"))}," ID IMDB ",2)]),l("div",Te,[l("div",$e,[ue(l("input",{ref_key:"searchInput",ref:C,"onUpdate:modelValue":e[4]||(e[4]=s=>t.value=s),placeholder:Q(),class:I(["search-input",{"wrong-layout":k.value}]),inputmode:n.value==="title"?"text":"numeric",onKeydown:[M(E(H,["prevent"]),["enter"]),M(E(G,["prevent"]),["tab"]),M(E(Z,["prevent"]),["down"])],onInput:j},null,42,xe),[[ce,t.value]]),l("div",Be,[t.value?(r(),f("button",{key:0,class:"reset-button",onClick:B},e[7]||(e[7]=[l("i",{class:"fas fa-times"},null,-1)]))):g("",!0),l("button",{class:"search-button",onClick:H},e[8]||(e[8]=[l("i",{class:"fas fa-search"},null,-1)]))]),k.value?(r(),f("div",{key:0,class:I(["layout-warning",{show:k.value}])},[e[9]||(e[9]=l("i",{class:"fas fa-keyboard"},null,-1)),N(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+J(x.value)+" раскладку ",1)],2)):g("",!0)])]),l("div",He,[t.value?g("",!0):(r(),f("div",Le,[l("h2",null,[e[10]||(e[10]=N(" История просмотра ")),v.value.length>0?(r(),f("span",Ae,[b(_e,{onClick:e[5]||(e[5]=s=>_.value=!0)}),b(we,{"is-open":_.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:X,onClose:e[6]||(e[6]=s=>_.value=!1)},null,8,["is-open"])])):g("",!0)]),u.value?(r(),f("div",Ke,[b(Ie)])):v.value.length===0?(r(),f("div",Ne,e[11]||(e[11]=[l("span",{class:"material-icons"},"movie",-1),l("p",null,"Здесь пока пусто",-1)]))):(r(),T(R(F),{key:2,"movies-list":v.value,"is-history":!0,loading:!1,onItemDeleted:z},null,8,["movies-list"]))])),!t.value&&o.value?(r(),T(U,{key:1,message:o.value,code:c.value},null,8,["message","code"])):g("",!0),w.value?(r(),f("div",Re,[e[12]||(e[12]=l("h2",null,"Результаты поиска",-1)),b(R(F),{"movies-list":m.value,"is-history":!1,loading:u.value},null,8,["movies-list","loading"]),m.value.length===0&&!u.value&&!o.value?(r(),f("div",Ue," Ничего не найдено ")):g("",!0),o.value?(r(),T(U,{key:1,message:o.value,code:c.value},null,8,["message","code"])):g("",!0)])):g("",!0),t.value&&!w.value&&!u.value&&!o.value?(r(),f("div",Oe,' Нажмите кнопку "Поиск" или Enter для поиска ')):g("",!0)])]),b(De)]))}},Je=Y(Fe,[["__scopeId","data-v-ce58d7ce"]]);export{Je as default};
