import{_ as O,r as u,c as q,o as V,a as G,b as k,d as p,e as s,f as S,w as Q,g,t as F,T as X,h as Z,u as ee,i as ae,j as te,k as se,l as le,n as I,m as oe,v as ne,p as B,q as re,s as A,x as K,y as L,E as N,z as ue,A as ie,B as ve,C as ce,D as b,F as de,G as pe,H as fe,U as R,I as he,J as me}from"./index-CRsjqibH.js";import{B as ge}from"./BaseModal-YGIV4hKw.js";import{D as ke,M as U}from"./MovieList-208cmraZ.js";const ye={class:"donaters-wrapper"},H="donatersCache",_e={__name:"FooterDonaters",setup(P){const i=u([]),h=u(-1);let v=null;const n=q(()=>h.value===-1||!i.value.length?"":i.value[h.value]),a=async()=>{const c=new Date().toISOString().split("T")[0],f=localStorage.getItem(H);if(f)try{const{date:o,data:d}=JSON.parse(f);if(o===c){i.value=d;return}}catch(o){console.error("Ошибка кэша донатеров:",o)}try{const o=await Z();i.value=o.split("\n").map(d=>d.trim()).filter(d=>d),localStorage.setItem(H,JSON.stringify({date:c,data:i.value}))}catch(o){console.error("Ошибка загрузки донатеров:",o)}};function m(){if(!i.value.length)return;const c=Math.floor(Math.random()*i.value.length);h.value=c}function r(){i.value.length!==0&&(m(),v=setInterval(m,4e3))}return V(async()=>{await a(),r()}),G(()=>{v&&clearInterval(v)}),(c,f)=>(p(),k("footer",null,[s("div",ye,[S(X,{name:"fade",mode:"out-in"},{default:Q(()=>[n.value?(p(),k("span",{key:h.value,class:"donater"},F(n.value),1)):g("",!0)]),_:1})])]))}},we=O(_e,[["__scopeId","data-v-5dec4e96"]]),Ie={class:"wrapper"},Se={class:"mainpage"},De={class:"search-type-buttons"},be={class:"search-container"},Ce={class:"input-wrapper"},Me=["placeholder","inputmode","onKeydown"],Te={class:"icons"},Ee={class:"content-container"},$e={key:0},xe={key:2},Be={key:0,class:"no-results"},Ae={key:3,class:"search-prompt"},Ke={__name:"MovieSearch",setup(P){const i=ee(),h=ae(),v=ue(),n=u("title"),a=u(""),m=u([]),r=u(!1),c=u(!1),f=u(!1),o=u(""),d=u(null),_=u([]),y=u(!1),C=u("");te(async()=>{if(r.value=!0,h.token)try{_.value=await fe(R.HISTORY),r.value=!1}catch(t){const{message:e,code:l}=b(t);o.value=e,d.value=l,console.error("Ошибка загрузки истории:",t),l===401&&(h.logout(),await v.push("/login"),v.go(0)),r.value=!1}else _.value=i.history,r.value=!1});function W(t){_.value=_.value.filter(e=>e.kp_id!==t)}const w=t=>{n.value=t,M(),y.value=!1},Y=t=>{n.value==="title"?(a.value=t.target.value,y.value=de(a.value),y.value&&(C.value=pe(a.value))):a.value=t.target.value.replace(/\D+/g,"")},J=()=>{y.value&&(a.value=he(a.value),y.value=!1)},z=()=>({title:"Введите название фильма",kinopoisk:"Пример: 301 (Матрица)",shikimori:"Пример: 28171 (Повар-боец Сома)",imdb:"Пример: 0198781 (Корпорация монстров)"})[n.value]||"Введите название фильма",M=()=>{a.value="",m.value=[],c.value=!1},T=()=>{E.cancel(),a.value?D():alert("Введите запрос для поиска")},D=async()=>{r.value=!0,c.value=!0,m.value=[];try{if(n.value==="kinopoisk"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,"")),v.push({name:"movie-info",params:{kp_id:a.value}});return}if(n.value==="imdb"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await ie(a.value);if(t.id_kp)v.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="shikimori"){/^\d+$/.test(a.value)||(a.value=a.value.replace(/\D/g,""));const t=await ve(a.value);if(t.id_kp)v.push({name:"movie-info",params:{kp_id:"".concat(t.id_kp)}});else throw new Error("Не найдено");return}if(n.value==="title"){const t=await ce(a.value);m.value=t.map(e=>{var l,$,x;return{...e,kp_id:e.id.toString(),rating_kp:((l=e.raw_data)==null?void 0:l.rating)!=="null"?($=e.raw_data)==null?void 0:$.rating:null,type:(x=e.raw_data)==null?void 0:x.type}})}}catch(t){const{message:e,code:l}=b(t);o.value=e,d.value=l,console.error("Ошибка при поиске:",t)}finally{r.value=!1}},j=async()=>{if(r.value=!0,h.token)try{await me(R.HISTORY),_.value=[],r.value=!1,f.value=!1}catch(t){const{message:e,code:l}=b(t);o.value=e,d.value=l,console.error("Ошибка загрузки истории:",t),l===401&&(h.logout(),await v.push("/login"),v.go(0)),r.value=!1,f.value=!1}else i.clearAllHistory(),r.value=!1,f.value=!1},E=se(()=>{a.value.length>=2?D():a.value.length<2&&(m.value=[],c.value=!1)},700);return V(()=>{const t=window.location.hash;if(t.startsWith("#search=")){const e=decodeURIComponent(t.replace("#search=",""));a.value=e,D()}else if(t.startsWith("#imdb=")){const e=decodeURIComponent(t.replace("#imdb=",""));w("imdb"),a.value=e,D()}else if(t.startsWith("#shiki")){const e=decodeURIComponent(t.replace("#shiki",""));w("shikimori"),a.value=e,D()}}),le(a,()=>{n.value==="title"&&E()}),(t,e)=>(p(),k("div",Ie,[s("div",Se,[s("div",De,[s("button",{class:I({active:n.value==="title"}),onClick:e[0]||(e[0]=l=>w("title"))}," Название ",2),s("button",{class:I({active:n.value==="kinopoisk"}),onClick:e[1]||(e[1]=l=>w("kinopoisk"))}," ID Кинопоиск ",2),s("button",{class:I({active:n.value==="shikimori"}),onClick:e[2]||(e[2]=l=>w("shikimori"))}," ID Shikimori ",2),s("button",{class:I({active:n.value==="imdb"}),onClick:e[3]||(e[3]=l=>w("imdb"))}," ID IMDB ",2)]),s("div",be,[s("div",Ce,[oe(s("input",{ref:"searchInput","onUpdate:modelValue":e[4]||(e[4]=l=>a.value=l),placeholder:z(),class:I(["search-input",{"wrong-layout":y.value}]),inputmode:n.value==="title"?"text":"numeric",onKeydown:[B(T,["enter"]),B(re(J,["prevent"]),["tab"])],onInput:Y},null,42,Me),[[ne,a.value]]),s("div",Te,[a.value?(p(),k("button",{key:0,class:"reset-button",onClick:M},e[7]||(e[7]=[s("i",{class:"fas fa-times"},null,-1)]))):g("",!0),s("button",{class:"search-button",onClick:T},e[8]||(e[8]=[s("i",{class:"fas fa-search"},null,-1)]))]),y.value?(p(),k("div",{key:0,class:I(["layout-warning",{show:y.value}])},[e[9]||(e[9]=s("i",{class:"fas fa-keyboard"},null,-1)),A(" Возможно, вы используете неправильную раскладку. Нажмите Tab для переключения на "+F(C.value)+" раскладку ",1)],2)):g("",!0)])]),s("div",Ee,[!a.value&&_.value.length>0?(p(),k("div",$e,[s("h2",null,[e[10]||(e[10]=A(" История просмотра ")),s("span",null,[S(ke,{onClick:e[5]||(e[5]=l=>f.value=!0)}),S(ge,{"is-open":f.value,message:"Вы уверены, что хотите очистить историю?",onConfirm:j,onClose:e[6]||(e[6]=l=>f.value=!1)},null,8,["is-open"])])]),S(L(U),{"movies-list":_.value,"is-history":!0,loading:r.value,onItemDeleted:W},null,8,["movies-list","loading"])])):g("",!0),!a.value&&o.value?(p(),K(N,{key:1,message:o.value,code:d.value},null,8,["message","code"])):g("",!0),c.value?(p(),k("div",xe,[e[11]||(e[11]=s("h2",null,"Результаты поиска",-1)),S(L(U),{"movies-list":m.value,"is-history":!1,loading:r.value},null,8,["movies-list","loading"]),m.value.length===0&&!r.value&&!o.value?(p(),k("div",Be," Ничего не найдено ")):g("",!0),o.value?(p(),K(N,{key:1,message:o.value,code:d.value},null,8,["message","code"])):g("",!0)])):g("",!0),a.value&&!c.value&&!r.value&&!o.value?(p(),k("div",Ae,' Нажмите кнопку "Поиск" или Enter для поиска ')):g("",!0)])]),S(we)]))}},Ue=O(Ke,[["__scopeId","data-v-5ad9680a"]]);export{Ue as default};
//# sourceMappingURL=MovieSearch-DfShQx6q.js.map
